<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>haloTool Plugin Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 100vw;
        margin: 0 auto;
        padding: 20px;
        background: #f5f7fa;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
      }

      .demo-section {
        background: white;
        margin: 20px 0;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .demo-section h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }

      .btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
      }

      .btn.success {
        background: linear-gradient(135deg, #27ae60, #229954);
      }
      .btn.warning {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }
      .btn.danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .output {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 13px;
        line-height: 1.4;
        max-height: 300px;
        overflow-y: auto;
      }

      .state-display {
        background: #34495e;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 12px;
        line-height: 1.4;
        max-height: 400px;
        overflow-y: auto;
      }

      .input-group {
        margin: 15px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #2c3e50;
        font-weight: 600;
      }

      .input-group input,
      .input-group textarea,
      .input-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #bdc3c7;
        border-radius: 6px;
        font-size: 14px;
      }

      .input-group input:focus,
      .input-group textarea:focus,
      .input-group select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .status.ready {
        background: #d5f4e6;
        color: #27ae60;
      }
      .status.loading {
        background: #fef9e7;
        color: #f39c12;
      }
      .status.error {
        background: #fadbd8;
        color: #e74c3c;
      }

      .code-block {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 13px;
        overflow-x: auto;
      }

      /* Enhanced button hover effects */
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .btn:active {
        transform: translateY(0);
      }

      /* Responsive grid improvements */
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        body {
          padding: 10px;
        }

        .demo-section {
          padding: 15px;
        }
      }

      /* Custom scrollbar for output areas */
      .output::-webkit-scrollbar,
      .state-display::-webkit-scrollbar {
        width: 8px;
      }

      .output::-webkit-scrollbar-track,
      .state-display::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .output::-webkit-scrollbar-thumb,
      .state-display::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .output::-webkit-scrollbar-thumb:hover,
      .state-display::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      /* Input field improvements */
      .input-group input,
      .input-group textarea,
      .input-group select {
        transition: all 0.2s ease;
      }

      .input-group input:hover,
      .input-group textarea:hover,
      .input-group select:hover {
        border-color: #95a5a6;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ”§ haloTool Plugin Demo</h1>
      <p>Interactive demonstration of the haloTool plugin system</p>
      <div id="init-status">
        <span class="status loading">Initializing...</span>
      </div>
    </div>

    <div class="demo-section">
      <h2>ğŸš€ Advanced HTTP Requests</h2>
      <p>Configure and test HTTP requests with full options and lifecycle triggers:</p>

      <div class="grid">
        <div>
          <!-- NEW: Tool Name and Type at the top -->
          <div class="input-group">
            <label>Tool Name:</label>
            <input
              type="text"
              id="tool-name"
              placeholder="Enter tool name (e.g., 'GetUserData', 'FetchPosts')"
              title="Tool Name"
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid #007bff;
                border-radius: 6px;
                font-weight: 600;
                font-size: 14px;
                background: #f8f9ff;
                margin-bottom: 8px;
              "
            />
          </div>

          <div class="input-group">
            <label>Tool Type:</label>
            <select
              id="tool-type"
              title="Tool Type"
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid #007bff;
                border-radius: 6px;
                font-weight: 600;
                font-size: 14px;
                background: #f8f9ff;
                margin-bottom: 8px;
              "
            >
              <option value="server">ğŸŒ Server Tool (API Calls, HTTP Requests)</option>
              <option value="client">ğŸ–¥ï¸ Client Tool (UI Actions, DOM Manipulation)</option>
              <option value="system">âš™ï¸ System Tool (State Operations, Transformations)</option>
            </select>
          </div>

          <!-- URL and Method on same line -->
          <div class="input-group">
            <label>Request:</label>
            <div style="display: flex; gap: 8px; align-items: stretch">
              <select
                id="http-method"
                title="HTTP Method"
                style="
                  width: 90px;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px 0 0 6px;
                  font-size: 12px;
                  font-weight: 600;
                  background: #f8f9fa;
                  border-right: none;
                  color: #495057;
                "
              >
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="PATCH">PATCH</option>
                <option value="DELETE">DELETE</option>
              </select>
              <input
                type="text"
                id="http-url"
                value="https://jsonplaceholder.typicode.com/posts/1"
                placeholder="https://api.example.com/endpoint"
                style="
                  flex: 1;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 0 6px 6px 0;
                  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                  font-size: 13px;
                  background: white;
                "
              />
            </div>
          </div>

          <div class="input-group">
            <label
              >Headers <span style="color: #6c757d; font-size: 12px">(JSON format)</span>:</label
            >
            <textarea
              id="http-headers"
              rows="3"
              placeholder='{"Content-Type": "application/json"}'
              style="
                font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                font-size: 12px;
                resize: vertical;
              "
            ></textarea>
          </div>

          <div class="input-group">
            <label
              >Request Body
              <span style="color: #6c757d; font-size: 12px">(JSON format)</span>:</label
            >
            <textarea
              id="http-body"
              rows="4"
              placeholder='{"title": "Test Post", "body": "This is a test", "userId": 1}'
            ></textarea>
          </div>

          <!-- NEW: Lifecycle Triggers Section -->
          <div class="input-group">
            <label
              >Lifecycle Trigger
              <span style="color: #6c757d; font-size: 12px">(when to execute this tool)</span
              >:</label
            >
            <select id="lifecycle-trigger" title="Lifecycle Trigger" style="margin-bottom: 10px">
              <option value="">Manual Execution Only</option>
              <option value="onTreeLaunch">ğŸš€ On Tree Launch</option>
              <option value="onPageEnter">ğŸ“„ On Page Enter</option>
              <option value="onPageExit">ğŸšª On Page Exit</option>
              <option value="onElementMount">ğŸ”§ On Element Mount</option>
              <option value="onElementChange">âœï¸ On Element Change</option>
              <option value="onElementUnmount">ğŸ—‘ï¸ On Element Unmount</option>
              <option value="onTreeComplete">ğŸ‰ On Tree Complete</option>
            </select>
            <small style="color: #6c757d; font-size: 11px; display: block; margin-top: 4px">
              Choose when this tool should automatically execute during the workflow lifecycle
            </small>
          </div>

          <!-- NEW: Response Actions Section -->
          <div class="input-group">
            <label
              >Response Actions
              <span style="color: #6c757d; font-size: 12px"
                >(what to do after successful response)</span
              >:</label
            >
            <div id="response-actions-container">
              <div
                class="response-action-row"
                style="
                  display: flex;
                  gap: 8px;
                  margin-bottom: 8px;
                  align-items: center;
                  background: #f8f9fa;
                  padding: 8px;
                  border-radius: 6px;
                  border: 1px solid #e9ecef;
                "
              >
                <select
                  title="Action Type"
                  style="
                    flex: 1;
                    padding: 6px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-size: 12px;
                  "
                  class="action-type"
                >
                  <option value="">No Action</option>
                  <option value="trigger-tool">ğŸ”§ Trigger Another Tool</option>
                  <option value="client-action">ğŸ–¥ï¸ Client Action</option>
                  <option value="state-update">ğŸ’¾ State Update</option>
                  <option value="conditional">ğŸ”€ Conditional Action</option>
                </select>
                <input
                  type="text"
                  placeholder="Action details..."
                  style="
                    flex: 2;
                    padding: 6px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                    font-size: 12px;
                  "
                  class="action-details"
                />
                <button
                  type="button"
                  onclick="removeResponseAction(this)"
                  style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                  "
                >
                  Ã—
                </button>
              </div>
            </div>
            <button
              type="button"
              onclick="addResponseAction()"
              style="
                background: #17a2b8;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 6px;
                font-size: 12px;
              "
            >
              + Add Response Action
            </button>
            <small style="color: #6c757d; font-size: 11px; display: block; margin-top: 6px">
              Define what should happen after this tool executes successfully
            </small>
          </div>
        </div>

        <div>
          <div class="input-group">
            <label>Authentication:</label>
            <select
              id="auth-type"
              onchange="toggleAuthFields()"
              title="Authentication Type"
              style="margin-bottom: 10px"
            >
              <option value="">No Authentication</option>
              <option value="bearer">Bearer Token</option>
              <option value="basic">Basic Auth</option>
              <option value="apiKey">API Key</option>
            </select>
          </div>

          <div
            id="auth-bearer"
            class="input-group"
            style="
              display: none;
              background: #f8f9fa;
              padding: 12px;
              border-radius: 6px;
              border-left: 3px solid #007bff;
              margin-top: 8px;
            "
          >
            <label style="margin-bottom: 6px; font-size: 13px; color: #495057">Bearer Token:</label>
            <input
              type="text"
              id="auth-token"
              placeholder="your-bearer-token"
              style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px"
            />
          </div>

          <div
            id="auth-basic"
            style="
              display: none;
              background: #f8f9fa;
              padding: 12px;
              border-radius: 6px;
              border-left: 3px solid #28a745;
              margin-top: 8px;
            "
          >
            <div class="input-group" style="margin-bottom: 8px">
              <label style="margin-bottom: 6px; font-size: 13px; color: #495057">Username:</label>
              <input
                type="text"
                id="auth-username"
                placeholder="username"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px"
              />
            </div>
            <div class="input-group" style="margin-bottom: 0">
              <label style="margin-bottom: 6px; font-size: 13px; color: #495057">Password:</label>
              <input
                type="password"
                id="auth-password"
                placeholder="password"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px"
              />
            </div>
          </div>

          <div
            id="auth-apikey"
            style="
              display: none;
              background: #f8f9fa;
              padding: 12px;
              border-radius: 6px;
              border-left: 3px solid #ffc107;
              margin-top: 8px;
            "
          >
            <div class="input-group" style="margin-bottom: 8px">
              <label style="margin-bottom: 6px; font-size: 13px; color: #495057"
                >Header/Query Key:</label
              >
              <input
                type="text"
                id="auth-key"
                placeholder="X-API-Key"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px"
              />
            </div>
            <div class="input-group" style="margin-bottom: 0">
              <label style="margin-bottom: 6px; font-size: 13px; color: #495057"
                >API Key Value:</label
              >
              <input
                type="text"
                id="auth-value"
                placeholder="your-api-key"
                style="
                  padding: 8px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                  font-size: 12px;
                "
              />
            </div>
          </div>

          <div class="input-group">
            <label>Save Response to State Path:</label>
            <input
              type="text"
              id="state-save-path"
              placeholder="api.response"
              value="api.response"
              style="
                font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                font-size: 12px;
                background: #f8f9fa;
              "
            />
          </div>

          <div class="input-group">
            <label
              >Field Mappings
              <span style="color: #6c757d; font-size: 12px">(extract specific fields)</span>:</label
            >
            <div id="field-mappings-container">
              <div
                class="mapping-row"
                style="
                  display: flex;
                  gap: 8px;
                  margin-bottom: 8px;
                  align-items: center;
                  background: #f8f9fa;
                  padding: 8px;
                  border-radius: 6px;
                  border: 1px solid #e9ecef;
                "
              >
                <input
                  type="text"
                  placeholder="$.company.name"
                  style="
                    flex: 1;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                    font-size: 12px;
                  "
                  class="mapping-from"
                />
                <span style="color: #6c757d; font-weight: bold">â†’</span>
                <input
                  type="text"
                  placeholder="form.company.name"
                  style="
                    flex: 1;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                    font-size: 12px;
                  "
                  class="mapping-to"
                />
                <button
                  type="button"
                  onclick="removeMappingRow(this)"
                  style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 6px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                    line-height: 1;
                  "
                >
                  Ã—
                </button>
              </div>
            </div>
            <button
              type="button"
              onclick="addMappingRow()"
              style="
                background: #28a745;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 8px;
                font-size: 13px;
              "
            >
              + Add Mapping
            </button>
            <small style="color: #6c757d; font-size: 11px; display: block; margin-top: 6px">
              Extract fields from API response using JSONPath ($.field.subfield) and save to state
              paths (form.company.name)
            </small>
          </div>
        </div>
      </div>

      <div
        style="
          display: flex;
          gap: 12px;
          align-items: center;
          margin-top: 20px;
          padding-top: 16px;
          border-top: 1px solid #e9ecef;
          flex-wrap: wrap;
        "
      >
        <button
          class="btn success"
          onclick="executeAdvancedRequest()"
          style="
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
          "
        >
          ğŸš€ Execute Request
        </button>
        <button
          onclick="saveToolAndClear()"
          style="
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
            margin-left: 8px;
          "
        >
          ğŸ’¾ Save Tool & Clear
        </button>
        <button
          class="btn"
          onclick="clearRequestForm()"
          style="
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px 20px;
            border-radius: 6px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
          "
        >
          ğŸ—‘ï¸ Clear Form
        </button>

        <div style="display: flex; gap: 8px; margin-left: auto; flex-wrap: wrap">
          <button
            class="btn"
            onclick="loadJSONPlaceholderExample()"
            style="
              background: #e3f2fd;
              border: 1px solid #2196f3;
              padding: 8px 12px;
              border-radius: 4px;
              color: #1976d2;
              font-size: 12px;
              cursor: pointer;
            "
          >
            ğŸ“„ GET Example
          </button>
          <button
            class="btn"
            onclick="loadPostExample()"
            style="
              background: #f3e5f5;
              border: 1px solid #9c27b0;
              padding: 8px 12px;
              border-radius: 4px;
              color: #7b1fa2;
              font-size: 12px;
              cursor: pointer;
            "
          >
            ğŸ“ POST Example
          </button>
          <button
            class="btn"
            onclick="loadFieldMappingExample()"
            style="
              background: #fff3e0;
              border: 1px solid #ff9800;
              padding: 8px 12px;
              border-radius: 4px;
              color: #f57c00;
              font-size: 12px;
              cursor: pointer;
            "
          >
            ğŸ”— Mapping Example
          </button>
          <button
            class="btn"
            onclick="loadTriggerWorkflowExample()"
            style="
              background: #fce4ec;
              border: 1px solid #e91e63;
              padding: 8px 12px;
              border-radius: 4px;
              color: #c2185b;
              cursor: pointer;
              font-size: 12px;
              margin-right: 8px;
              margin-bottom: 8px;
            "
          >
            ğŸš€ Trigger Workflow
          </button>
        </div>
      </div>

      <div class="output" id="http-output">Configure and execute HTTP requests...</div>
    </div>

    <!-- NEW: Workflow & Trigger Management Section -->
    <div class="demo-section">
      <h2>ğŸ”„ Workflow & Trigger Management</h2>
      <p>Create tools and manage lifecycle triggers for automated workflows:</p>

      <div
        style="
          background: #e3f2fd;
          border: 1px solid #2196f3;
          border-radius: 6px;
          padding: 12px;
          margin-bottom: 20px;
        "
      >
        <h4 style="margin: 0 0 8px 0; color: #1976d2">ğŸ“‹ How to Create & Test Tools:</h4>
        <ol style="margin: 0; padding-left: 20px; color: #1565c0; font-size: 14px">
          <li>
            <strong>Name:</strong> Enter a tool name in "Advanced HTTP Requests" section above
          </li>
          <li>
            <strong>Configure:</strong> Set up your HTTP request (URL, method, headers, auth, etc.)
          </li>
          <li>
            <strong>Save:</strong> Click "ğŸ’¾ Save Tool & Clear" to save and prepare for next tool
          </li>
          <li>
            <strong>Test:</strong> Use the â–¶ button next to your saved tool OR use lifecycle event
            buttons
          </li>
          <li><strong>Manage:</strong> Edit (ğŸ“), Execute (â–¶), or Delete (Ã—) your saved tools</li>
        </ol>
      </div>

      <div class="grid">
        <div>
           <div class="input-group">
             <label>State Management Testing:</label>
             <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
               <button
                 class="btn"
                 onclick="updateFormValue('make', 'Toyota')"
                 style="background: #28a745; color: white; font-size: 12px; padding: 6px 12px;"
               >
                 ğŸš— Set Make: Toyota
               </button>
               <button
                 class="btn"
                 onclick="updateUIOptions('make', [{id: 'toyota', name: 'Toyota'}, {id: 'honda', name: 'Honda'}])"
                 style="background: #17a2b8; color: white; font-size: 12px; padding: 6px 12px;"
               >
                 ğŸ“‹ Load Make Options
               </button>
               <button
                 class="btn"
                 onclick="validateFormState()"
                 style="background: #ffc107; color: black; font-size: 12px; padding: 6px 12px;"
               >
                 âœ… Validate Form
               </button>
             </div>
             <div style="display: flex; gap: 8px; flex-wrap: wrap;">
               <button
                 class="btn"
                 onclick="createStateCheckpoint('demo-checkpoint')"
                 style="background: #6f42c1; color: white; font-size: 12px; padding: 6px 12px;"
               >
                 ğŸ’¾ Create Checkpoint
               </button>
               <button
                 class="btn"
                 onclick="restoreStateCheckpoint('demo-checkpoint')"
                 style="background: #fd7e14; color: white; font-size: 12px; padding: 6px 12px;"
               >
                 ğŸ”„ Restore Checkpoint
               </button>
             </div>
           </div>

          <div class="input-group">
            <label>Simulate Workflow Events:</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px">
              <button
                class="btn"
                onclick="simulateLifecycleEvent('onTreeLaunch')"
                style="background: #28a745; font-size: 12px; padding: 8px"
              >
                ğŸš€ Tree Launch
              </button>
              <button
                class="btn"
                onclick="simulateLifecycleEvent('onPageEnter')"
                style="background: #17a2b8; font-size: 12px; padding: 8px"
              >
                ğŸ“„ Page Enter
              </button>
              <button
                class="btn"
                onclick="simulateLifecycleEvent('onElementMount')"
                style="background: #6f42c1; font-size: 12px; padding: 8px"
              >
                ğŸ”§ Element Mount
              </button>
              <button
                class="btn"
                onclick="simulateLifecycleEvent('onPageExit')"
                style="background: #fd7e14; font-size: 12px; padding: 8px"
              >
                ğŸšª Page Exit
              </button>
              <button
                class="btn"
                onclick="simulateLifecycleEvent('onElementChange')"
                style="background: #20c997; font-size: 12px; padding: 8px"
              >
                âœï¸ Element Change
              </button>
              <button
                class="btn"
                onclick="simulateLifecycleEvent('onTreeComplete')"
                style="background: #e83e8c; font-size: 12px; padding: 8px"
              >
                ğŸ‰ Tree Complete
              </button>
            </div>
          </div>
        </div>

        <div>
          <div class="input-group">
            <label
              >Registered Tools
              <span style="color: #6c757d; font-size: 12px"
                >(saved HTTP request configurations)</span
              >:</label
            >
            <div
              id="registered-tools-list"
              style="
                max-height: 250px;
                overflow-y: auto;
                border: 2px solid #28a745;
                border-radius: 6px;
                padding: 12px;
                background: #f8fff8;
              "
            >
              <!-- Tools will be populated here -->
            </div>
            <button
              class="btn"
              onclick="clearAllTools()"
              style="
                width: 100%;
                margin-top: 8px;
                background: #dc3545;
                color: white;
                font-size: 12px;
                padding: 8px;
              "
            >
              ğŸ—‘ï¸ Clear All Tools
            </button>
          </div>

          <div class="input-group">
            <label>Active Triggers:</label>
            <div
              id="active-triggers-list"
              style="
                max-height: 150px;
                overflow-y: auto;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 8px;
                background: #f8f9fa;
              "
            >
              <!-- Active triggers will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <div class="output" id="workflow-output">
        Workflow events and tool executions will appear here...
      </div>
    </div>

    <div class="demo-section">
      <h2>ğŸš€ Quick API Calls</h2>
      <p>Simple API call methods for quick testing:</p>

      <div class="input-group">
        <label>API URL:</label>
        <input
          type="text"
          id="api-url"
          value="https://jsonplaceholder.typicode.com/users/1"
          placeholder="Enter API URL"
        />
      </div>

      <button class="btn" onclick="quickGet()">GET Request</button>
      <button class="btn" onclick="quickPost()">POST Request</button>
      <button class="btn success" onclick="quickGetWithState()">GET â†’ State</button>

      <div class="output" id="api-output">Ready for API calls...</div>
    </div>

    <div class="grid">
      <div class="demo-section">
        <h2>ğŸ—ï¸ Tool Creation</h2>
        <p>Create and execute custom tools:</p>

        <button class="btn" onclick="createServerTool()">Create Server Tool</button>
        <button class="btn" onclick="createSystemTool()">Create System Tool</button>
        <button class="btn warning" onclick="executeCustomTool()">Execute Custom Tool</button>

        <div class="output" id="tool-output">Tools ready to be created...</div>
      </div>

      <div class="demo-section">
        <h2>ğŸ”„ State Management</h2>
        <p>Manage application state:</p>

        <div class="input-group">
          <label>State Path:</label>
          <input type="text" id="state-path" value="user.name" placeholder="e.g., user.name" />
        </div>
        <div class="input-group">
          <label>State Value:</label>
          <input type="text" id="state-value" value="John Doe" placeholder="Enter value" />
        </div>

        <button class="btn" onclick="updateState()">Update State</button>
        <button class="btn" onclick="getState()">Get State</button>
        <button class="btn danger" onclick="clearState()">Clear State</button>

        <pre
          id="state-display"
          style="
            background-color: #1e1e1e;
            color: #dcdcdc;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
          "
        >
State will appear here...</pre
        >
      </div>
    </div>

    <div class="demo-section">
      <h2>âš¡ Workflow Execution</h2>
      <p>Execute sequences of tools:</p>

      <button class="btn success" onclick="runWorkflow()">Run Sample Workflow</button>
      <button class="btn" onclick="runParallelWorkflow()">Run Parallel Workflow</button>

      <div class="output" id="workflow-output">Workflow results will appear here...</div>
    </div>

    <div class="demo-section">
      <h2>ğŸ“Š Monitoring & Metrics</h2>
      <p>View system metrics and monitoring data:</p>

      <button class="btn" onclick="showMetrics()">Show Metrics</button>
      <button class="btn" onclick="showTools()">List All Tools</button>
      <button class="btn warning" onclick="simulateError()">Simulate Error</button>

      <div class="output" id="metrics-output">Metrics will appear here...</div>
    </div>

    <div class="demo-section">
      <h2>ğŸ’» Code Examples</h2>
      <p>Here's how to use haloTool in your applications:</p>

      <h3>Basic Usage:</h3>
      <div class="code-block">
        // Simple API call const result = await haloTool.get('https://api.example.com/data'); //
        Update state haloTool.state.set({ user: { name: 'John', role: 'admin' } }); // Execute
        workflow const results = await haloTool.workflow(['tool1', 'tool2', 'tool3']);
      </div>

      <h3>Advanced Tool Creation:</h3>
      <div class="code-block">
        // Create a server tool await haloTool.createServerTool({ id: 'fetchUserProfile', name:
        'Fetch User Profile', description: 'Fetches user profile data', url:
        'https://api.example.com/users/{{$.userId}}', method: 'GET', assignments: [{ source:
        'response', valuePath: '$.user', statePath: '$.currentUser' }], cache: { ttlSec: 300,
        strategy: 'memory' }, retry: { max: 3, strategy: 'exponential' } });
      </div>
    </div>

    <!-- Load haloTool -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="./dist/halo-tool.browser.js"></script>
    
    <!-- Halo State Management Plugin -->
    <script src="./dist/state/halo-state-plugin.browser.js"></script>
    <script>
      // Initialize the real haloTool plugin
      let haloTool;

      async function initializehaloTool() {
        try {
          // The browser bundle exposes HaloTool globally on window
          if (typeof window.HaloTool !== 'undefined') {
            haloTool = window.HaloTool;

            console.log('haloTool', haloTool);

            // Initialize if needed
            if (haloTool.init && typeof haloTool.init === 'function') {
              await haloTool.init({
                enableMetrics: true,
                enableTracing: false,
                enableErrorTracking: true,
                enableStateManagement: true,
                globalAccess: true,
              });
            }

            // Initialize Halo State Plugin
            const haloStatePlugin = createHaloStatePlugin({
              enableEventSourcing: true,
              enableCheckpoints: true,
              enableValidation: true,
              enableDependencyTracking: true,
              debugMode: true,
              maxEventLogSize: 500,
              maxCheckpoints: 5
            });

            // Make state plugin globally accessible
            window.haloStatePlugin = haloStatePlugin;

            // Replace haloTool's state management with our plugin
            haloTool.getState = () => haloStatePlugin.getState();
            haloTool.setState = (state) => haloStatePlugin.setState(state);

            // Set up state plugin event listeners
            haloStatePlugin.on('stateChanged', (newState, oldState) => {
              console.log('ğŸ”„ State changed:', { newState, oldState });
              updateStateDisplay();
            });

            haloStatePlugin.on('formFieldChanged', (fieldName, value, oldValue) => {
              console.log(`ğŸ“ Form field changed: ${fieldName}`, { value, oldValue });
            });

            haloStatePlugin.on('dependentFieldCleared', (depField, parentField, parentValue) => {
              console.log(`ğŸ”— Dependent field cleared: ${depField} (parent: ${parentField})`, { parentValue });
            });

            haloStatePlugin.on('fieldValidated', (fieldName, isValid, errors) => {
              console.log(`âœ… Field validated: ${fieldName}`, { isValid, errors });
            });

            // Set up dependencies based on Halo architecture
            haloStatePlugin.registerDependency('make', ['model']);

            // Initialize lifecycle triggers
            haloStatePlugin.onTreeLaunch();

            logToWorkflowOutput('ğŸš€ HaloTool initialized with Halo State Plugin');
            logToWorkflowOutput(`ğŸ“Š State structure: session, context, form, ui, tools, _events, _meta`);
            logToWorkflowOutput(`ğŸ”— Widget dependencies: make â†’ model (cascading updates)`);
            logToWorkflowOutput(`ğŸ¯ Lifecycle triggers: onTreeLaunch, onPageEnter, onPageExit, onTreeComplete`);
            logToWorkflowOutput(`ğŸ” Event sourcing enabled with ${haloStatePlugin.getEventLog().length} events`);
            
            // Force update state display
            updateStateDisplay();

            document.getElementById('init-status').innerHTML =
              '<span class="status ready">Ready</span>';
            log('âœ… HaloTool initialized successfully!');
          } else {
            throw new Error(
              'window.HaloTool not found. Make sure the browser bundle is loaded correctly.'
            );
          }
        } catch (error) {
          document.getElementById('init-status').innerHTML =
            '<span class="status error">Error</span>';
          console.error('Failed to initialize haloTool:', error);

          // Fallback to mock for demo purposes
          initializeMockhaloTool();
        }
      }

      function log(message, type = 'info') {
        const outputs = ['api-output', 'tool-output', 'workflow-output', 'metrics-output'];
        outputs.forEach(id => {
          const output = document.getElementById(id);
          if (
            output &&
            (output.textContent.includes('Ready') || output.textContent.includes('will appear'))
          ) {
            output.innerHTML = `<div style="color: #3498db;">[${new Date().toLocaleTimeString()}] ${message}</div>`;
          }
        });
      }

      // Initialize haloTool when page loads
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initializehaloTool, 1000);
      });

      // Fallback mock implementation for demo purposes
      function initializeMockhaloTool() {
        haloTool = {
          async request(url, options = {}, statePath) {
            const { method = 'GET', headers = {}, body, auth } = options;
            log(`${method} ${url}`, 'info');

            if (auth) {
              log(`Using ${auth.type} authentication`, 'info');
            }

            try {
              // Simulate API call with more realistic mock data
              const mockData = {
                id: Math.floor(Math.random() * 1000),
                title: 'Mock Response',
                message: `Mock ${method} response from ${url}`,
                timestamp: new Date().toISOString(),
                requestHeaders: headers,
                requestBody: body,
              };

              if (statePath) {
                this.state = this.state || { data: {} };
                this.updateState(statePath, mockData);
              }

              const result = {
                success: true,
                data: mockData,
                status: 200,
                statusText: 'OK',
                headers: {
                  'content-type': 'application/json',
                  'x-mock-response': 'true',
                },
              };
              log(`âœ… ${method} successful: ${JSON.stringify(result, null, 2)}`);
              return result;
            } catch (error) {
              log(`âŒ ${method} failed: ${error.message}`, 'error');
              throw error;
            }
          },

          async get(url, statePath) {
            return this.request(url, { method: 'GET' }, statePath);
          },

          async post(url, data, statePath) {
            return this.request(url, { method: 'POST', body: data }, statePath);
          },

          async put(url, data, statePath) {
            return this.request(url, { method: 'PUT', body: data }, statePath);
          },

          async patch(url, data, statePath) {
            return this.request(url, { method: 'PATCH', body: data }, statePath);
          },

          async delete(url, statePath) {
            return this.request(url, { method: 'DELETE' }, statePath);
          },

          async createServerTool(config) {
            log(`Creating server tool: ${config.name}`);
            this.tools = this.tools || new Map();
            this.tools.set(config.id, { ...config, type: 'server' });
            log(`âœ… Server tool '${config.id}' created successfully`);
            return config.id;
          },

          async createSystemTool(config) {
            log(`Creating system tool: ${config.name}`);
            this.tools = this.tools || new Map();
            this.tools.set(config.id, { ...config, type: 'system' });
            log(`âœ… System tool '${config.id}' created successfully`);
            return config.id;
          },

          async executeTool(toolId, context) {
            const tool = this.tools?.get(toolId);
            if (!tool) {
              throw new Error(`Tool '${toolId}' not found`);
            }

            log(`Executing tool: ${tool.name}`);

            // Simulate tool execution
            await new Promise(resolve => setTimeout(resolve, 500));

            const result = {
              success: true,
              data: { message: `Tool '${toolId}' executed successfully`, timestamp: Date.now() },
              executionTime: 500,
            };

            log(`âœ… Tool execution completed: ${JSON.stringify(result, null, 2)}`);
            return result;
          },

          async workflow(toolIds, initialState = {}) {
            log(`Starting workflow with tools: [${toolIds.join(', ')}]`);

            const results = [];
            for (const toolId of toolIds) {
              log(`Executing workflow step: ${toolId}`);
              await new Promise(resolve => setTimeout(resolve, 300));

              results.push({
                toolId,
                success: true,
                data: { step: toolId, completed: new Date().toISOString() },
                executionTime: 300,
              });
            }

            log(`âœ… Workflow completed successfully with ${results.length} steps`);
            return results;
          },

          getState() {
            return this.state?.data || {};
          },

          setState(newState) {
            this.state = this.state || {};
            this.state.data = { ...newState };
            log(`State updated: ${JSON.stringify(this.state.data, null, 2)}`);
          },

          updateState(path, value) {
            this.state = this.state || { data: {} };
            const parts = path.split('.');
            let current = this.state.data;

            for (let i = 0; i < parts.length - 1; i++) {
              if (!current[parts[i]]) current[parts[i]] = {};
              current = current[parts[i]];
            }

            current[parts[parts.length - 1]] = value;
            log(`State path '${path}' updated to: ${JSON.stringify(value)}`);
          },

          getMetrics() {
            return [
              { name: 'tools.executed', value: this.tools?.size || 0, timestamp: Date.now() },
              { name: 'api.calls', value: Math.floor(Math.random() * 100), timestamp: Date.now() },
              { name: 'cache.hits', value: Math.floor(Math.random() * 50), timestamp: Date.now() },
            ];
          },

          getAllTools() {
            return Array.from(this.tools?.values() || []);
          },

          captureError(error) {
            log(`âŒ Error captured: ${error.message}`, 'error');
            return `error_${Date.now()}`;
          },

          state: { data: {} },
          tools: new Map(),
        };

        document.getElementById('init-status').innerHTML =
          '<span class="status ready">Ready (Mock)</span>';
        log('âš ï¸ Mock HaloTool initialized as fallback');
      }

      // Simple JSONPath extraction function
      function extractValue(obj, path) {
        if (!path || !obj) return undefined;

        // Remove leading $ if present
        const cleanPath = path.replace(/^\$\.?/, '');

        if (!cleanPath) return obj;

        const parts = cleanPath.split('.');
        let current = obj;

        for (const part of parts) {
          if (current === null || current === undefined) return undefined;

          // Handle array indices [0], [1], etc.
          if (part.includes('[') && part.includes(']')) {
            const [key, indexStr] = part.split('[');
            const index = parseInt(indexStr.replace(']', ''));

            if (key) {
              current = current[key];
            }

            if (Array.isArray(current) && !isNaN(index)) {
              current = current[index];
            }
          } else {
            current = current[part];
          }
        }

        return current;
      }

      // Set nested value in object using dot notation
      function setNestedValue(obj, path, value) {
        const parts = path.split('.');
        let current = obj;

        for (let i = 0; i < parts.length - 1; i++) {
          if (!current[parts[i]] || typeof current[parts[i]] !== 'object') {
            current[parts[i]] = {};
          }
          current = current[parts[i]];
        }

        current[parts[parts.length - 1]] = value;
      }

      // Field mapping row management
      function addMappingRow() {
        const container = document.getElementById('field-mappings-container');
        const newRow = document.createElement('div');
        newRow.className = 'mapping-row';
        newRow.style.cssText =
          'display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #e9ecef;';
        newRow.innerHTML = `
                <input type="text" placeholder="$.address.city" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px;" class="mapping-from">
                <span style="color: #6c757d; font-weight: bold;">â†’</span>
                <input type="text" placeholder="form.address.city" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px;" class="mapping-to">
                <button type="button" onclick="removeMappingRow(this)" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; line-height: 1;">Ã—</button>
            `;
        container.appendChild(newRow);
      }

      function removeMappingRow(button) {
        const container = document.getElementById('field-mappings-container');
        // Keep at least one row
        if (container.children.length > 1) {
          button.parentNode.remove();
        }
      }

      function clearAllMappings() {
        const container = document.getElementById('field-mappings-container');
        container.innerHTML = `
                <div class="mapping-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                    <input type="text" placeholder="$.company.name" style="flex: 1;" class="mapping-from">
                    <span style="color: #7f8c8d;">â†’</span>
                    <input type="text" placeholder="form.company.name" style="flex: 1;" class="mapping-to">
                    <button type="button" onclick="removeMappingRow(this)" style="background: #e74c3c; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer;">Ã—</button>
                </div>
            `;
      }

      function getMappingsFromUI() {
        const mappings = [];
        const rows = document.querySelectorAll('.mapping-row');

        rows.forEach(row => {
          const fromInput = row.querySelector('.mapping-from');
          const toInput = row.querySelector('.mapping-to');

          if (fromInput.value.trim() && toInput.value.trim()) {
            mappings.push({
              from: fromInput.value.trim(),
              to: toInput.value.trim(),
            });
          }
        });

        return mappings;
      }

      function setMappingsInUI(mappings) {
        const container = document.getElementById('field-mappings-container');
        container.innerHTML = '';

        if (mappings.length === 0) {
          clearAllMappings();
          return;
        }

        mappings.forEach(mapping => {
          const newRow = document.createElement('div');
          newRow.className = 'mapping-row';
          newRow.style.cssText =
            'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
          newRow.innerHTML = `
                    <input type="text" placeholder="$.field.name" style="flex: 1;" class="mapping-from" value="${mapping.from}">
                    <span style="color: #7f8c8d;">â†’</span>
                    <input type="text" placeholder="form.field.name" style="flex: 1;" class="mapping-to" value="${mapping.to}">
                    <button type="button" onclick="removeMappingRow(this)" style="background: #e74c3c; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer;">Ã—</button>
                `;
          container.appendChild(newRow);
        });
      }

      // Debug function to test field mapping logic
      function testFieldMapping() {
        const testData = {
          address: {
            city: 'Gwenborough',
            street: 'Kulas Light',
            suite: 'Apt. 556',
          },
          company: {
            name: 'Romaguera-Crona',
            catchPhrase: 'Multi-layered client-server',
          },
          name: 'Leanne Graham',
          username: 'Bret',
          email: 'Sincere@april.biz',
          phone: '1-770-736-8031 x56442',
          website: 'hildegard.org',
        };

        console.log('ğŸ§ª Testing field mapping logic...');
        console.log('Test data:', testData);

        const mappings = [
          { from: '$.address.city', to: 'form.address.city' },
          { from: '$.company.name', to: 'form.company.name' },
          { from: '$.name', to: 'form.user.fullName' },
        ];

        const currentState = {};

        mappings.forEach(mapping => {
          const value = extractValue(testData, mapping.from);
          console.log(`Extracting ${mapping.from}:`, value);

          if (value !== undefined) {
            setNestedValue(currentState, mapping.to, value);
            console.log(`Set ${mapping.to} =`, value);
          }
        });

        console.log('Final state:', currentState);
        return currentState;
      }

      // Add this to window for easy testing
      window.testFieldMapping = testFieldMapping;

      // NEW: Response Action Management Functions
      function addResponseAction() {
        const container = document.getElementById('response-actions-container');
        const newRow = document.createElement('div');
        newRow.className = 'response-action-row';
        newRow.style.cssText =
          'display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #e9ecef;';
        newRow.innerHTML = `
                <select style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" class="action-type">
                    <option value="">No Action</option>
                    <option value="trigger-tool">ğŸ”§ Trigger Another Tool</option>
                    <option value="client-action">ğŸ–¥ï¸ Client Action</option>
                    <option value="state-update">ğŸ’¾ State Update</option>
                    <option value="conditional">ğŸ”€ Conditional Action</option>
                </select>
                <input type="text" placeholder="Action details..." style="flex: 2; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px;" class="action-details">
                <button type="button" onclick="removeResponseAction(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Ã—</button>
            `;
        container.appendChild(newRow);
      }

      function removeResponseAction(button) {
        const container = document.getElementById('response-actions-container');
        if (container.children.length > 1) {
          button.parentNode.remove();
        }
      }

      function getResponseActionsFromUI() {
        const actions = [];
        const rows = document.querySelectorAll('.response-action-row');

        rows.forEach(row => {
          const typeSelect = row.querySelector('.action-type');
          const detailsInput = row.querySelector('.action-details');

          if (typeSelect.value && detailsInput.value.trim()) {
            actions.push({
              type: typeSelect.value,
              details: detailsInput.value.trim(),
            });
          }
        });

        return actions;
      }

      // NEW: Enhanced State Management Functions following Halo Architecture

      // Event sourcing helper - logs all state changes
      function logStateEvent(eventType, path, newValue, oldValue = null) {
        const currentState = haloTool.getState();
        if (currentState._events) {
          const event = {
            id: `event_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
            type: eventType,
            timestamp: new Date().toISOString(),
            path: path,
            newValue: newValue,
            oldValue: oldValue,
            metadata: {
              triggeredBy: 'tool-execution',
              source: 'plugin-demo'
            }
          };
          
          currentState._events.log.push(event);
          
          // Keep only last 100 events to prevent memory issues
          if (currentState._events.log.length > 100) {
            currentState._events.log = currentState._events.log.slice(-100);
          }
          
          haloTool.setState(currentState);
          logToWorkflowOutput(`ğŸ“ Event logged: ${eventType} at ${path}`);
        }
      }

      // Create state checkpoint for rollback capability
      function createStateCheckpoint(checkpointId) {
        const currentState = haloTool.getState();
        if (currentState._events) {
          currentState._events.checkpoints[checkpointId] = {
            id: checkpointId,
            timestamp: new Date().toISOString(),
            state: JSON.parse(JSON.stringify(currentState)) // Deep clone
          };
          currentState._events.currentCheckpoint = checkpointId;
          haloTool.setState(currentState);
          logToWorkflowOutput(`ğŸ’¾ Checkpoint created: ${checkpointId}`);
        }
      }

      // Restore state from checkpoint
      function restoreStateCheckpoint(checkpointId) {
        const currentState = haloTool.getState();
        if (currentState._events && currentState._events.checkpoints[checkpointId]) {
          const checkpoint = currentState._events.checkpoints[checkpointId];
          haloTool.setState(checkpoint.state);
          logToWorkflowOutput(`ğŸ”„ State restored from checkpoint: ${checkpointId}`);
          updateStateDisplay();
          return true;
        }
        logToWorkflowOutput(`âŒ Checkpoint not found: ${checkpointId}`);
        return false;
      }

      // Widget dependency tracking and cascading updates
      function updateFormValue(fieldName, value, triggerDependencies = true) {
        const currentState = haloTool.getState();
        const oldValue = currentState.form[fieldName]?.value;
        
        // Update the form field
        if (!currentState.form[fieldName]) {
          currentState.form[fieldName] = {
            value: null,
            errors: [],
            touched: false,
            valid: false
          };
        }
        
        currentState.form[fieldName].value = value;
        currentState.form[fieldName].touched = true;
        currentState.form[fieldName].valid = value !== null && value !== '';
        
        // Log the state change
        logStateEvent('form-update', `form.${fieldName}.value`, value, oldValue);
        
        // Handle dependencies (like make â†’ model)
        if (triggerDependencies && currentState.form[fieldName].dependencies) {
          const dependencies = currentState.form[fieldName].dependencies;
          logToWorkflowOutput(`ğŸ”— Triggering ${dependencies.length} dependent field(s): ${dependencies.join(', ')}`);
          
          dependencies.forEach(depField => {
            // Clear dependent field values
            if (currentState.form[depField]) {
              currentState.form[depField].value = null;
              currentState.form[depField].touched = false;
              currentState.form[depField].valid = false;
              logToWorkflowOutput(`ğŸ§¹ Cleared dependent field: ${depField}`);
            }
            
            // Clear dependent UI options
            if (currentState.ui[depField]) {
              currentState.ui[depField].options = [];
              currentState.ui[depField].loading = false;
              currentState.ui[depField].error = null;
              logToWorkflowOutput(`ğŸ§¹ Cleared UI options for: ${depField}`);
            }
          });
        }
        
        // Update metadata
        currentState._meta.lastUpdated = new Date().toISOString();
        currentState._meta.performance.updateCount++;
        
        haloTool.setState(currentState);
        updateStateDisplay();
        
        logToWorkflowOutput(`âœ… Form field updated: ${fieldName} = ${JSON.stringify(value)}`);
        
        return currentState;
      }

      // Update UI options (like dropdown options from API calls)
      function updateUIOptions(fieldName, options, loading = false, error = null) {
        const currentState = haloTool.getState();
        
        if (!currentState.ui[fieldName]) {
          currentState.ui[fieldName] = {
            options: [],
            loading: false,
            error: null,
            lastFetched: null
          };
        }
        
        const oldOptions = currentState.ui[fieldName].options;
        currentState.ui[fieldName].options = options;
        currentState.ui[fieldName].loading = loading;
        currentState.ui[fieldName].error = error;
        currentState.ui[fieldName].lastFetched = new Date().toISOString();
        
        // Log the state change
        logStateEvent('ui-update', `ui.${fieldName}.options`, options, oldOptions);
        
        // Update metadata
        currentState._meta.lastUpdated = new Date().toISOString();
        
        haloTool.setState(currentState);
        updateStateDisplay();
        
        logToWorkflowOutput(`âœ… UI options updated: ${fieldName} (${options.length} options)`);
        
        return currentState;
      }

      // Validate form state
      function validateFormState() {
        const currentState = haloTool.getState();
        let isValid = true;
        const errors = [];
        
        // Validate required fields
        const requiredFields = ['make', 'model']; // Example required fields
        
        requiredFields.forEach(field => {
          if (!currentState.form[field] || !currentState.form[field].value) {
            isValid = false;
            errors.push(`${field} is required`);
            
            if (currentState.form[field]) {
              currentState.form[field].errors = [`${field} is required`];
              currentState.form[field].valid = false;
            }
          }
        });
        
        // Update validation state
        currentState._meta.validation.isValid = isValid;
        currentState._meta.validation.errors = errors;
        currentState.ui.page.validationErrors = errors;
        currentState.ui.page.canNavigate = isValid;
        
        haloTool.setState(currentState);
        updateStateDisplay();
        
        logToWorkflowOutput(`ğŸ” Form validation: ${isValid ? 'VALID' : 'INVALID'} (${errors.length} errors)`);
        
        return { isValid, errors };
      }

      // Simulate lifecycle events for testing
      function simulateLifecycleEvent(eventType) {
        logToWorkflowOutput(`ğŸ­ [${new Date().toLocaleTimeString()}] Simulating lifecycle event: ${eventType}`);
        
        const currentState = haloTool.getState();
        
        switch (eventType) {
          case 'onTreeLaunch':
            // Update session info
            currentState.session.startedAt = new Date().toISOString();
            currentState.context.workflow.currentStep = 1;
            createStateCheckpoint('tree-launch');
            break;
            
          case 'onPageEnter':
            // Update page info
            currentState.session.currentPage = `demo-page-${currentState.context.workflow.currentStep}`;
            currentState.session.pageHistory.push(currentState.session.currentPage);
            currentState.ui.page.loading = false;
            break;
            
          case 'onPageExit':
            // Validate before exit
            const validation = validateFormState();
            if (!validation.isValid) {
              logToWorkflowOutput(`âŒ Page exit blocked due to validation errors`);
              return false;
            }
            currentState.context.workflow.completedSteps.push(currentState.context.workflow.currentStep);
            break;
            
          case 'onTreeComplete':
            // Finalize workflow
            currentState.context.workflow.currentStep = currentState.context.workflow.totalSteps;
            currentState.context.workflow.completedSteps = [1, 2, 3];
            createStateCheckpoint('tree-complete');
            break;
        }
        
        // Update metadata
        currentState._meta.lastUpdated = new Date().toISOString();
        
        haloTool.setState(currentState);
        updateStateDisplay();
        
        // Execute registered tools for this trigger
        if (triggerHandlers.has(eventType)) {
          const toolIds = triggerHandlers.get(eventType);
          logToWorkflowOutput(`âš¡ Executing ${toolIds.length} tool(s) for ${eventType} trigger`);
          
          toolIds.forEach(async (toolId) => {
            await executeRegisteredTool(toolId, eventType);
          });
        }
        
        // NEW: Enhanced State Management Functions following Halo Architecture

      // Helper function to update form values using the state plugin
      function updateFormValue(fieldName, value) {
        if (window.haloStatePlugin) {
          window.haloStatePlugin.updateFormField(fieldName, value, {
            triggerValidation: true,
            triggerDependencies: true,
            metadata: { triggeredBy: 'demo-button', source: 'user-interaction' }
          });
          logToWorkflowOutput(`ğŸ“ Updated form field: ${fieldName} = ${JSON.stringify(value)}`);
        }
      }

      // Helper function to update UI field options using the state plugin
      function updateUIOptions(fieldName, options) {
        if (window.haloStatePlugin) {
          window.haloStatePlugin.updateUIField(fieldName, { 
            options, 
            loading: false, 
            error: null 
          }, {
            triggeredBy: 'demo-button',
            source: 'options-load'
          });
          logToWorkflowOutput(`ğŸ“‹ Updated UI options for ${fieldName}: ${options.length} options`);
        }
      }

      // Helper function to validate form state
      function validateFormState() {
        if (window.haloStatePlugin) {
          const validation = window.haloStatePlugin.validateForm();
          logToWorkflowOutput(`âœ… Form validation: ${validation.isValid ? 'VALID' : 'INVALID'}`);
          if (validation.errors.length > 0) {
            logToWorkflowOutput(`âŒ Validation errors: ${validation.errors.join(', ')}`);
          }
          return validation.isValid;
        }
        return false;
      }

      // Helper function to create a checkpoint
      function createStateCheckpoint(id, description) {
        if (window.haloStatePlugin) {
          window.haloStatePlugin.createCheckpoint(id, description);
          logToWorkflowOutput(`ğŸ“¸ Created checkpoint: ${id} - ${description}`);
        }
      }

      // Helper function to restore a checkpoint
      function restoreStateCheckpoint(id) {
        if (window.haloStatePlugin) {
          const success = window.haloStatePlugin.restoreCheckpoint(id);
          if (success) {
            logToWorkflowOutput(`ğŸ”„ Restored checkpoint: ${id}`);
          } else {
            logToWorkflowOutput(`âŒ Failed to restore checkpoint: ${id}`);
          }
          return success;
        }
        return false;
      }

      // Helper function to simulate widget dependency trigger
      function simulateWidgetDependency() {
        if (window.haloStatePlugin) {
          // First update make field
          updateFormValue('make', 'Toyota');
          
          // Wait a bit then show the dependency effect
          setTimeout(() => {
            // Update UI with model options for Toyota
            updateUIOptions('model', [
              { id: 'camry', name: 'Camry' },
              { id: 'corolla', name: 'Corolla' },
              { id: 'prius', name: 'Prius' },
              { id: 'rav4', name: 'RAV4' }
            ]);
            logToWorkflowOutput(`ğŸ”— Dependency triggered: make â†’ model options updated`);
          }, 500);
        }
      }

      // Helper function to demonstrate lifecycle events
      function simulateLifecycleEvent(eventType) {
        if (window.haloStatePlugin) {
          switch (eventType) {
            case 'onTreeLaunch':
              window.haloStatePlugin.onTreeLaunch();
              logToWorkflowOutput(`ğŸš€ Lifecycle event: ${eventType}`);
              break;
            case 'onPageEnter':
              window.haloStatePlugin.onPageEnter('demo-page-2');
              logToWorkflowOutput(`ğŸ“„ Lifecycle event: ${eventType} (demo-page-2)`);
              break;
            case 'onPageExit':
              const canExit = window.haloStatePlugin.onPageExit();
              logToWorkflowOutput(`ğŸšª Lifecycle event: ${eventType} - ${canExit ? 'ALLOWED' : 'BLOCKED'}`);
              break;
            case 'onTreeComplete':
              window.haloStatePlugin.onTreeComplete();
              logToWorkflowOutput(`ğŸ‰ Lifecycle event: ${eventType}`);
              break;
          }
        }
      }

      return true;
      }

      // NEW: Tool Management System
      const registeredTools = new Map();
      const triggerHandlers = new Map();

      function createToolFromForm() {
        const toolName = document.getElementById('tool-name').value.trim();
        const toolType = document.getElementById('tool-type').value;
        const lifecycleTrigger = document.getElementById('lifecycle-trigger').value;
        const responseActions = getResponseActionsFromUI();

        if (!toolName) {
          alert('Please enter a tool name');
          return;
        }

        const toolId = `tool_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;

        // Get current form settings
        const url = document.getElementById('http-url').value;
        const method = document.getElementById('http-method').value;
        const headers = document.getElementById('http-headers').value;
        const body = document.getElementById('http-body').value;
        const statePath = document.getElementById('state-save-path').value;
        const fieldMappings = getMappingsFromUI();

        const toolConfig = {
          id: toolId,
          name: toolName,
          type: toolType,
          trigger: lifecycleTrigger,
          responseActions: responseActions,
          config: {
            url: url,
            method: method,
            headers: headers ? JSON.parse(headers) : {},
            body: body ? JSON.parse(body) : null,
            statePath: statePath,
            fieldMappings: fieldMappings,
          },
          createdAt: new Date().toISOString(),
        };

        // Register the tool
        registeredTools.set(toolId, toolConfig);

        // Register trigger handler if specified
        if (lifecycleTrigger) {
          if (!triggerHandlers.has(lifecycleTrigger)) {
            triggerHandlers.set(lifecycleTrigger, []);
          }
          triggerHandlers.get(lifecycleTrigger).push(toolId);
        }

        // Update UI
        updateRegisteredToolsList();
        updateActiveTriggersList();

        // Log success
        logToWorkflowOutput(
          `âœ… Tool '${toolName}' (${toolType}) created successfully with ID: ${toolId}`
        );
        if (lifecycleTrigger) {
          logToWorkflowOutput(`ğŸ”— Tool registered for trigger: ${lifecycleTrigger}`);
        }
        if (responseActions.length > 0) {
          logToWorkflowOutput(
            `âš¡ Tool configured with ${responseActions.length} response action(s)`
          );
        }

        // Clear tool name for next creation
        document.getElementById('tool-name').value = '';
      }

      // NEW: Save tool and clear form for next tool
      function saveToolAndClear() {
        const toolName = document.getElementById('tool-name').value.trim();

        if (!toolName) {
          alert('Please enter a tool name before saving');
          document.getElementById('tool-name').focus();
          return;
        }

        // Save the tool using existing function
        createToolFromForm();

        // Clear the entire form for next tool
        clearRequestForm();

        logToWorkflowOutput(`ğŸ¯ Tool saved! Form cleared for next tool creation.`);
      }

      // NEW: Create a quick test tool for demonstration
      function createQuickTestTool() {
        // Set up a simple test tool
        document.getElementById('tool-name').value = 'TestUserFetcher';
        document.getElementById('tool-type').value = 'server';
        document.getElementById('http-url').value = 'https://jsonplaceholder.typicode.com/users/1';
        document.getElementById('http-method').value = 'GET';
        document.getElementById('http-headers').value = '{}';
        document.getElementById('http-body').value = '';
        document.getElementById('lifecycle-trigger').value = 'onTreeLaunch';
        document.getElementById('state-save-path').value = 'api.testUser';

        // Clear existing mappings and add a simple one
        clearAllMappings();
        const mappings = [{ from: '$.name', to: 'user.displayName' }];
        setMappingsInUI(mappings);

        // Clear and add response action
        clearAllResponseActions();
        addResponseActionWithValues('state-update', 'workflow.status = "user-loaded"');

        // Create the tool
        createToolFromForm();

        logToWorkflowOutput(
          'ğŸ¯ Quick test tool created! Try clicking "ğŸš€ Tree Launch" to test it.'
        );
      }

      function updateRegisteredToolsList() {
        const container = document.getElementById('registered-tools-list');

        if (registeredTools.size === 0) {
          container.innerHTML =
            '<div style="text-align: center; color: #6c757d; padding: 20px; font-style: italic;">No tools saved yet<br><small>Configure an HTTP request above and click "ğŸ’¾ Save as New Tool"</small></div>';
          return;
        }

        let html = '';
        registeredTools.forEach((tool, toolId) => {
          const typeIcon = tool.type === 'server' ? 'ğŸŒ' : tool.type === 'client' ? 'ğŸ–¥ï¸' : 'âš™ï¸';
          const triggerBadge = tool.trigger
            ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 4px;">${tool.trigger}</span>`
            : '';
          const actionsBadge =
            tool.responseActions.length > 0
              ? `<span style="background: #fff3e0; color: #f57c00; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 4px;">${tool.responseActions.length} actions</span>`
              : '';

          // Show URL and method for server tools
          const configInfo =
            tool.type === 'server'
              ? `<div style="font-size: 11px; color: #6c757d; margin-top: 4px; font-family: monospace;">${tool.config.method} ${tool.config.url}</div>`
              : '';

          html += `
                     <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                         <div style="display: flex; justify-content: space-between; align-items: center;">
                             <div style="flex: 1;">
                                 <div style="font-weight: 600; font-size: 14px; color: #2c3e50;">${typeIcon} ${tool.name}</div>
                                 <div style="font-size: 11px; color: #6c757d; margin-top: 2px;">
                                     ID: ${toolId.substr(-6)}${triggerBadge}${actionsBadge}
                                 </div>
                                 ${configInfo}
                             </div>
                             <div style="display: flex; gap: 4px;">
                                 <button onclick="loadToolToForm('${toolId}')" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;" title="Load to form">ğŸ“</button>
                                 <button onclick="executeRegisteredTool('${toolId}')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;" title="Execute now">â–¶</button>
                                 <button onclick="deleteRegisteredTool('${toolId}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;" title="Delete">Ã—</button>
                             </div>
                         </div>
                     </div>
                 `;
        });

        container.innerHTML = html;
      }

      // NEW: Clear all registered tools
      function clearAllTools() {
        if (registeredTools.size === 0) {
          logToWorkflowOutput('â„¹ï¸ No tools to clear');
          return;
        }

        const count = registeredTools.size;
        registeredTools.clear();
        triggerHandlers.clear();
        updateRegisteredToolsList();
        updateActiveTriggersList();
        logToWorkflowOutput(`ğŸ—‘ï¸ Cleared ${count} registered tool(s)`);
      }

      // NEW: Delete a specific tool
      function deleteRegisteredTool(toolId) {
        const tool = registeredTools.get(toolId);
        if (!tool) return;

        // Remove from registered tools
        registeredTools.delete(toolId);

        // Remove from trigger handlers
        if (tool.trigger) {
          const handlers = triggerHandlers.get(tool.trigger);
          if (handlers) {
            const index = handlers.indexOf(toolId);
            if (index > -1) {
              handlers.splice(index, 1);
              if (handlers.length === 0) {
                triggerHandlers.delete(tool.trigger);
              }
            }
          }
        }

        updateRegisteredToolsList();
        updateActiveTriggersList();
        logToWorkflowOutput(`ğŸ—‘ï¸ Deleted tool: ${tool.name}`);
      }

      // NEW: Load a tool's configuration back to the form
      function loadToolToForm(toolId) {
        const tool = registeredTools.get(toolId);
        if (!tool) return;

        // Load the tool's configuration back to the form
        document.getElementById('http-url').value = tool.config.url || '';
        document.getElementById('http-method').value = tool.config.method || 'GET';
        document.getElementById('http-headers').value = tool.config.headers
          ? JSON.stringify(tool.config.headers, null, 2)
          : '';
        document.getElementById('http-body').value = tool.config.body
          ? JSON.stringify(tool.config.body, null, 2)
          : '';
        document.getElementById('lifecycle-trigger').value = tool.trigger || '';
        document.getElementById('state-save-path').value = tool.config.statePath || '';

        // Load field mappings
        if (tool.config.fieldMappings) {
          setMappingsInUI(tool.config.fieldMappings);
        } else {
          clearAllMappings();
        }

        // Load response actions
        clearAllResponseActions();
        if (tool.responseActions && tool.responseActions.length > 0) {
          tool.responseActions.forEach(action => {
            addResponseActionWithValues(action.type, action.details);
          });
        }

        logToWorkflowOutput(`ğŸ“ Loaded tool configuration: ${tool.name}`);
      }

      function updateActiveTriggersList() {
        const container = document.getElementById('active-triggers-list');

        if (triggerHandlers.size === 0) {
          container.innerHTML = '<em style="color: #6c757d;">No active triggers</em>';
          return;
        }

        let html = '';
        triggerHandlers.forEach((toolIds, trigger) => {
          const triggerIcon = getTriggerIcon(trigger);
          html += `
                    <div style="margin-bottom: 6px; padding: 6px; background: white; border-radius: 4px; border: 1px solid #e9ecef;">
                        <div style="font-weight: 600; font-size: 12px; color: #495057;">${triggerIcon} ${trigger}</div>
                        <div style="font-size: 11px; color: #6c757d;">${toolIds.length} tool(s) registered</div>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      function getTriggerIcon(trigger) {
        const icons = {
          onTreeLaunch: 'ğŸš€',
          onPageEnter: 'ğŸ“„',
          onPageExit: 'ğŸšª',
          onElementMount: 'ğŸ”§',
          onElementChange: 'âœï¸',
          onElementUnmount: 'ğŸ—‘ï¸',
          onTreeComplete: 'ğŸ‰',
        };
        return icons[trigger] || 'âš¡';
      }

      function simulateLifecycleEvent(eventType) {
        logToWorkflowOutput(
          `\nğŸ­ Simulating lifecycle event: ${getTriggerIcon(eventType)} ${eventType}`
        );

        const handlersForEvent = triggerHandlers.get(eventType);
        if (!handlersForEvent || handlersForEvent.length === 0) {
          logToWorkflowOutput(`â„¹ï¸ No tools registered for ${eventType} event`);
          return;
        }

        logToWorkflowOutput(
          `ğŸ” Found ${handlersForEvent.length} tool(s) to execute for ${eventType}`
        );

        // Execute each tool registered for this event
        handlersForEvent.forEach(async toolId => {
          const tool = registeredTools.get(toolId);
          if (tool) {
            logToWorkflowOutput(`âš¡ Executing tool: ${tool.name} (${tool.type})`);
            await executeRegisteredTool(toolId, eventType);
          }
        });
      }

      async function executeRegisteredTool(toolId, triggeredBy = 'manual') {
        const tool = registeredTools.get(toolId);
        if (!tool) {
          logToWorkflowOutput(`âŒ Tool ${toolId} not found`);
          return;
        }

        const startTime = Date.now();
        logToWorkflowOutput(`ğŸš€ [${new Date().toLocaleTimeString()}] Starting execution of ${tool.type} tool: "${tool.name}" (triggered by: ${triggeredBy})`);

        try {
          let result;

          if (tool.type === 'server') {
            // Execute HTTP request with detailed logging
            const url = tool.config.url;
            const method = tool.config.method;
            const headers = tool.config.headers || {};
            const body = tool.config.body;

            logToWorkflowOutput(`ğŸŒ Making ${method} request to: ${url}`);
            logToWorkflowOutput(`ğŸ“‹ Headers: ${JSON.stringify(headers)}`);
            if (body && method !== 'GET') {
              logToWorkflowOutput(`ğŸ“¦ Body: ${JSON.stringify(body)}`);
            }

            // Add timeout to prevent hanging
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
              controller.abort();
              logToWorkflowOutput(`â° Request timed out after 30 seconds`);
            }, 30000);

            try {
              const options = {
                method: tool.config.method,
                headers: tool.config.headers,
                body: tool.config.body,
                signal: controller.signal
              };

              result = await haloTool.request(tool.config.url, options, tool.config.statePath);
              clearTimeout(timeoutId);

              logToWorkflowOutput(`ğŸ“¡ Response received - Success: ${result.success}`);
              logToWorkflowOutput(`ğŸ“„ Response data: ${JSON.stringify(result.data, null, 2).substring(0, 500)}${JSON.stringify(result.data, null, 2).length > 500 ? '...' : ''}`);

              // Process field mappings
              if (result.success && tool.config.fieldMappings && tool.config.fieldMappings.length > 0) {
                logToWorkflowOutput(`ğŸ”„ Processing ${tool.config.fieldMappings.length} field mapping(s)...`);
                
                const currentState = haloTool.getState();
                tool.config.fieldMappings.forEach((mapping, index) => {
                  if (mapping.from && mapping.to) {
                    logToWorkflowOutput(`ğŸ” [Mapping ${index + 1}] Extracting from: ${mapping.from}`);
                    const value = extractValue(result.data, mapping.from);
                    if (value !== undefined) {
                      setNestedValue(currentState, mapping.to, value);
                      logToWorkflowOutput(`âœ… [Mapping ${index + 1}] Mapped ${mapping.from} â†’ ${mapping.to}: ${JSON.stringify(value)}`);
                    } else {
                      logToWorkflowOutput(`âŒ [Mapping ${index + 1}] Could not extract value from path: ${mapping.from}`);
                    }
                  }
                });
                
                // Update metadata
                if (currentState._meta) {
                  currentState._meta.lastUpdated = new Date().toISOString();
                }
                
                haloTool.setState(currentState);
                logToWorkflowOutput(`ğŸ”„ State updated with field mappings`);
                
                // Force update the state display
                updateStateDisplay();
              }

            } catch (fetchError) {
              clearTimeout(timeoutId);
              if (fetchError.name === 'AbortError') {
                throw new Error('Request timed out after 30 seconds');
              } else {
                throw fetchError;
              }
            }

          } else if (tool.type === 'client') {
            // Execute client action
            logToWorkflowOutput(`ğŸ–¥ï¸ Executing client action...`);
            result = {
              success: true,
              data: `Client tool '${tool.name}' executed`,
              action: 'client',
            };
            logToWorkflowOutput(`ğŸ–¥ï¸ Client tool executed: ${tool.name}`);
            
          } else if (tool.type === 'system') {
            // Execute system operation
            logToWorkflowOutput(`âš™ï¸ Executing system operation...`);
            result = {
              success: true,
              data: `System tool '${tool.name}' executed`,
              operation: 'system',
            };
            logToWorkflowOutput(`âš™ï¸ System tool executed: ${tool.name}`);
          }

          const duration = Date.now() - startTime;
          logToWorkflowOutput(`âœ… [${new Date().toLocaleTimeString()}] Tool '${tool.name}' completed successfully in ${duration}ms`);

          // Process response actions
          if (result.success && tool.responseActions && tool.responseActions.length > 0) {
            logToWorkflowOutput(`âš¡ Processing ${tool.responseActions.length} response action(s)...`);

            for (let i = 0; i < tool.responseActions.length; i++) {
              const action = tool.responseActions[i];
              logToWorkflowOutput(`ğŸ¯ [Action ${i + 1}] Executing: ${action.type} - ${JSON.stringify(action.details)}`);
              await executeResponseAction(action, result, tool);
              logToWorkflowOutput(`âœ… [Action ${i + 1}] Completed`);
            }
          }

        } catch (error) {
          const duration = Date.now() - startTime;
          logToWorkflowOutput(`ğŸ’¥ [${new Date().toLocaleTimeString()}] Tool '${tool.name}' failed after ${duration}ms: ${error.message}`);
          logToWorkflowOutput(`ğŸ” Error details: ${error.stack || 'No stack trace available'}`);
          console.error('Tool execution error:', error);
        }
      }

      // Track execution depth to prevent infinite loops
      let executionDepth = 0;
      const MAX_EXECUTION_DEPTH = 5;

      async function executeResponseAction(action, toolResult, parentTool) {
        if (executionDepth >= MAX_EXECUTION_DEPTH) {
          logToWorkflowOutput(`ğŸ›‘ Maximum execution depth (${MAX_EXECUTION_DEPTH}) reached. Preventing infinite loop.`);
          return;
        }

        executionDepth++;
        logToWorkflowOutput(`âš¡ [Depth ${executionDepth}] Executing response action: ${action.type} - ${JSON.stringify(action.details)}`);

        try {
          switch (action.type) {
            case 'trigger-tool':
              // Find and execute another tool
              const targetToolId = action.details;
              logToWorkflowOutput(`ğŸ” Looking for tool: ${targetToolId}`);
              
              const targetTool = Array.from(registeredTools.values()).find(
                t => t.name === targetToolId || t.id === targetToolId
              );
              
              if (targetTool) {
                logToWorkflowOutput(`ğŸ”— Triggering tool: ${targetTool.name} (${targetTool.id})`);
                await executeRegisteredTool(targetTool.id, `response-action-from-${parentTool.name}`);
              } else {
                logToWorkflowOutput(`âš ï¸ Target tool '${targetToolId}' not found`);
                logToWorkflowOutput(`ğŸ“‹ Available tools: ${Array.from(registeredTools.values()).map(t => t.name).join(', ')}`);
              }
              break;

            case 'client-action':
              logToWorkflowOutput(`ğŸ–¥ï¸ Executing client action: ${action.details}`);
              // Simulate client action execution
              await new Promise(resolve => setTimeout(resolve, 100));
              logToWorkflowOutput(`âœ… Client action '${action.details}' completed`);
              break;

            case 'state-update':
              logToWorkflowOutput(`ğŸ’¾ Updating state: ${action.details}`);
              try {
                const [path, value] = action.details.split('=');
                if (path && value) {
                  const currentState = haloTool.getState();
                  const parsedValue = JSON.parse(value.trim());
                  setNestedValue(currentState, path.trim(), parsedValue);
                  
                  // Update metadata
                  if (currentState._meta) {
                    currentState._meta.lastUpdated = new Date().toISOString();
                  }
                  
                  haloTool.setState(currentState);
                  logToWorkflowOutput(`âœ… State updated: ${path.trim()} = ${JSON.stringify(parsedValue)}`);
                  
                  // Force update the state display
                  updateStateDisplay();
                } else {
                  logToWorkflowOutput(`âŒ Invalid state update format. Expected: 'path=value'`);
                }
              } catch (parseError) {
                logToWorkflowOutput(`âŒ Failed to parse state update value: ${parseError.message}`);
              }
              break;

            case 'conditional':
              logToWorkflowOutput(`ğŸ”€ Evaluating condition: ${action.details}`);
              // Simulate conditional execution
              await new Promise(resolve => setTimeout(resolve, 50));
              logToWorkflowOutput(`âœ… Condition '${action.details}' evaluated`);
              break;

            default:
              logToWorkflowOutput(`â“ Unknown response action type: ${action.type}`);
              break;
          }
        } catch (error) {
          logToWorkflowOutput(`ğŸ’¥ Response action failed: ${error.message}`);
          console.error('Response action error:', error);
        } finally {
          executionDepth--;
          logToWorkflowOutput(`â¬…ï¸ [Depth ${executionDepth + 1}] Response action completed: ${action.type}`);
        }
      }

      function logToWorkflowOutput(message) {
        const output = document.getElementById('workflow-output');
        const timestamp = new Date().toLocaleTimeString();
        output.innerHTML += `<div style="margin-bottom: 4px;"><span style="color: #6c757d; font-size: 11px;">[${timestamp}]</span> ${message}</div>`;
        output.scrollTop = output.scrollHeight;
      }

      // Initialize the UI
      updateRegisteredToolsList();
      updateActiveTriggersList();

      // Demo functions
      function toggleAuthFields() {
        const authType = document.getElementById('auth-type').value;

        // Hide all auth fields
        document.getElementById('auth-bearer').style.display = 'none';
        document.getElementById('auth-basic').style.display = 'none';
        document.getElementById('auth-apikey').style.display = 'none';

        // Show relevant auth fields
        if (authType === 'bearer') {
          document.getElementById('auth-bearer').style.display = 'block';
        } else if (authType === 'basic') {
          document.getElementById('auth-basic').style.display = 'block';
        } else if (authType === 'apiKey') {
          document.getElementById('auth-apikey').style.display = 'block';
        }
      }

      async function executeAdvancedRequest() {
        const output = document.getElementById('http-output');

        try {
          // Get form values
          const url = document.getElementById('http-url').value;
          const method = document.getElementById('http-method').value;
          const headersText = document.getElementById('http-headers').value;
          const bodyText = document.getElementById('http-body').value;
          const authType = document.getElementById('auth-type').value;
          const statePath = document.getElementById('state-save-path').value;
          const fieldMappings = getMappingsFromUI();

          if (!url) {
            throw new Error('URL is required');
          }

          output.innerHTML = '<div style="color: #f39c12;">ğŸ”„ Executing request...</div>';

          // Parse headers
          let headers = {};
          if (headersText.trim()) {
            try {
              headers = JSON.parse(headersText);
            } catch (e) {
              throw new Error('Invalid JSON in headers field');
            }
          }

          // Parse body
          let body = null;
          if (bodyText.trim() && method !== 'GET') {
            try {
              body = JSON.parse(bodyText);
            } catch (e) {
              // If not valid JSON, use as string
              body = bodyText;
            }
          }

          // Setup authentication
          let auth = null;
          if (authType) {
            auth = { type: authType };

            if (authType === 'bearer') {
              auth.token = document.getElementById('auth-token').value;
            } else if (authType === 'basic') {
              auth.username = document.getElementById('auth-username').value;
              auth.password = document.getElementById('auth-password').value;
            } else if (authType === 'apiKey') {
              auth.key = document.getElementById('auth-key').value;
              auth.value = document.getElementById('auth-value').value;
            }
          }

          // Execute request using haloTool's enhanced request method
          const options = {
            method,
            headers,
            body,
            auth,
          };

          // Execute the request (without auto-saving to state path yet)
          const result = await haloTool.request(url, options);

          // Get current state for processing
          const currentState = haloTool.getState();

          // First, save to statePath if provided
          if (statePath) {
            setNestedValue(currentState, statePath, result.data);
          }

          // Process field mappings if provided
          let mappingResults = [];
          console.log('â§Ÿâ§Ÿâ§Ÿ fieldMappings: ', fieldMappings);

          if (fieldMappings.length > 0) {
            for (const mapping of fieldMappings) {
              if (mapping.from && mapping.to) {
                const extractedValue = extractValue(result.data, mapping.from);
                console.log('â§Ÿâ§Ÿâ§Ÿ extractedValue: ', extractedValue);
                if (extractedValue !== undefined) {
                  setNestedValue(currentState, mapping.to, extractedValue);
                  console.log('â§Ÿâ§Ÿâ§Ÿ currentState: ', currentState);
                  mappingResults.push({
                    from: mapping.from,
                    to: mapping.to,
                    value: extractedValue,
                  });
                  console.log(`âœ… Mapped ${mapping.from} â†’ ${mapping.to}:`, extractedValue);
                } else {
                  console.warn(`âš ï¸ Could not extract value from path: ${mapping.from}`);
                }
              }
            }
          }

          // Update the state with all changes
          // Update metadata before setting state
          if (currentState._meta) {
            currentState._meta.lastUpdated = new Date().toISOString();
          }
          
          haloTool.setState(currentState);

          output.innerHTML = `
                    <div style="color: #27ae60;">âœ… Request ${result.success ? 'Successful' : 'Failed'}!</div>
                    <div style="margin-top: 10px;"><strong>Status:</strong> ${result.status} ${result.statusText}</div>
                    <div style="margin-top: 5px;"><strong>Headers:</strong></div>
                    <pre style="font-size: 11px; margin: 5px 0;">${JSON.stringify(result.headers, null, 2)}</pre>
                    <div style="margin-top: 5px;"><strong>Response Data:</strong></div>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    ${statePath ? `<div style="color: #3498db; margin-top: 10px;">ğŸ’¾ Response saved to state path: <strong>${statePath}</strong></div>` : ''}
                    ${
                      mappingResults.length > 0
                        ? `
                        <div style="color: #9b59b6; margin-top: 10px;">ğŸ”— <strong>Field Mappings Applied:</strong></div>
                        ${mappingResults
                          .map(
                            mapping => `
                            <div style="font-size: 12px; margin: 3px 0; padding: 3px 8px; background: #f8f9fa; border-radius: 4px;">
                                <strong>${mapping.from}</strong> â†’ <strong>${mapping.to}</strong>: 
                                <span style="color: #2c3e50;">${JSON.stringify(mapping.value)}</span>
                            </div>
                        `
                          )
                          .join('')}
                    `
                        : ''
                    }
                `;

          // Update state display if response was saved or field mappings were applied
          if (statePath || mappingResults.length > 0) {
            console.log('ğŸ”„ Updating state display...');
            console.log('Current state after mappings:', currentState);
            updateStateDisplay();
            logToWorkflowOutput(`ğŸ”„ State display updated with ${mappingResults.length} field mapping(s)`);
          }
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error: ${error.message}</div>`;
        }
      }

      function clearRequestForm() {
        document.getElementById('tool-name').value = '';
        document.getElementById('tool-type').value = 'server'; // Reset to default
        document.getElementById('http-url').value = '';
        document.getElementById('http-method').value = 'GET';
        document.getElementById('http-headers').value = '';
        document.getElementById('http-body').value = '';
        document.getElementById('auth-type').value = '';
        document.getElementById('auth-token').value = '';
        document.getElementById('auth-username').value = '';
        document.getElementById('auth-password').value = '';
        document.getElementById('auth-key').value = '';
        document.getElementById('auth-value').value = '';
        document.getElementById('state-save-path').value = '';
        document.getElementById('lifecycle-trigger').value = '';
        clearAllMappings();
        clearAllResponseActions();
        toggleAuthFields();

        const output = document.getElementById('http-output');
        output.innerHTML = 'Form cleared - ready for new tool configuration...';

        logToWorkflowOutput('ğŸ§¹ Form cleared - ready for new tool configuration');
      }

      function loadJSONPlaceholderExample() {
        document.getElementById('http-url').value = 'https://jsonplaceholder.typicode.com/users/1';
        document.getElementById('http-method').value = 'GET';
        document.getElementById('http-headers').value = JSON.stringify(
          {
            Accept: 'application/json',
            'User-Agent': 'HaloTool-Demo/1.0',
          },
          null,
          2
        );
        document.getElementById('http-body').value = '';
        document.getElementById('auth-type').value = '';
        document.getElementById('state-save-path').value = 'examples.user';
        clearAllMappings();
        toggleAuthFields();
      }

      function loadPostExample() {
        document.getElementById('http-url').value = 'https://jsonplaceholder.typicode.com/posts';
        document.getElementById('http-method').value = 'POST';
        document.getElementById('http-headers').value = JSON.stringify(
          {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          },
          null,
          2
        );
        document.getElementById('http-body').value = JSON.stringify(
          {
            title: 'HaloTool Demo Post',
            body: 'This is a test post created using HaloTool',
            userId: 1,
          },
          null,
          2
        );
        document.getElementById('auth-type').value = '';
        document.getElementById('state-save-path').value = 'examples.newPost';
        clearAllMappings();
        toggleAuthFields();
      }

      function loadFieldMappingExample() {
        document.getElementById('http-url').value = 'https://jsonplaceholder.typicode.com/users/1';
        document.getElementById('http-method').value = 'GET';
        document.getElementById('http-headers').value = JSON.stringify(
          {
            Accept: 'application/json',
          },
          null,
          2
        );
        document.getElementById('http-body').value = '';
        document.getElementById('auth-type').value = '';
        document.getElementById('state-save-path').value = 'api.fullResponse';

        // Set up field mappings in the UI
        const mappings = [
          { from: '$.address.city', to: 'form.address.city' },
          { from: '$.address.street', to: 'form.address.street' },
          { from: '$.address.suite', to: 'form.address.suite' },
          { from: '$.company.name', to: 'form.company.name' },
          { from: '$.company.catchPhrase', to: 'form.company.slogan' },
          { from: '$.name', to: 'form.user.fullName' },
          { from: '$.username', to: 'form.user.username' },
          { from: '$.email', to: 'form.user.email' },
          { from: '$.phone', to: 'form.user.phone' },
          { from: '$.website', to: 'form.user.website' },
        ];
        setMappingsInUI(mappings);
        toggleAuthFields();
      }

      // NEW: Load example with lifecycle triggers and response actions
      function loadTriggerWorkflowExample() {
        // Load a user data fetch that triggers on tree launch
        document.getElementById('http-method').value = 'GET';
        document.getElementById('http-url').value = 'https://jsonplaceholder.typicode.com/users/1';
        document.getElementById('http-headers').value = JSON.stringify(
          { 'Content-Type': 'application/json' },
          null,
          2
        );
        document.getElementById('http-body').value = '';
        document.getElementById('auth-type').value = '';
        document.getElementById('state-save-path').value = 'workflow.currentUser';
        document.getElementById('lifecycle-trigger').value = 'onTreeLaunch';

        // Clear existing mappings and actions
        clearAllMappings();
        clearAllResponseActions();

        // Set up field mappings
        const mappings = [
          { from: '$.name', to: 'user.name' },
          { from: '$.email', to: 'user.email' },
        ];
        setMappingsInUI(mappings);

        // Set up response actions
        addResponseActionWithValues('state-update', 'workflow.step = "user-loaded"');
        addResponseActionWithValues('trigger-tool', 'UserPostsLoader');

        toggleAuthFields();

        // Show instructions
        logToWorkflowOutput('ğŸ“‹ Trigger Workflow Example loaded:');
        logToWorkflowOutput('1ï¸âƒ£ This tool will execute on Tree Launch');
        logToWorkflowOutput('2ï¸âƒ£ It will fetch user data and map it to state');
        logToWorkflowOutput('3ï¸âƒ£ On success, it will update workflow step and trigger another tool');
        logToWorkflowOutput(
          '4ï¸âƒ£ Click "Create Tool" to register it, then simulate "Tree Launch" to test'
        );
      }

      function clearAllResponseActions() {
        const container = document.getElementById('response-actions-container');
        container.innerHTML = `
          <div class="response-action-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #e9ecef;">
            <select style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" class="action-type">
              <option value="">No Action</option>
              <option value="trigger-tool">ğŸ”§ Trigger Another Tool</option>
              <option value="client-action">ğŸ–¥ï¸ Client Action</option>
              <option value="state-update">ğŸ’¾ State Update</option>
              <option value="conditional">ğŸ”€ Conditional Action</option>
            </select>
            <input type="text" placeholder="Action details..." style="flex: 2; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px;" class="action-details">
            <button type="button" onclick="removeResponseAction(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Ã—</button>
          </div>
        `;
      }

      function addResponseActionWithValues(type, details) {
        addResponseAction();
        const rows = document.querySelectorAll('.response-action-row');
        const lastRow = rows[rows.length - 1];
        lastRow.querySelector('.action-type').value = type;
        lastRow.querySelector('.action-details').value = details;
      }

      // Demo functions
      async function quickGet() {
        const url = document.getElementById('api-url').value;
        const output = document.getElementById('api-output');

        try {
          output.innerHTML = '<div style="color: #f39c12;">Loading...</div>';
          const result = await haloTool.get(url);
          output.innerHTML = `<div style="color: #27ae60;">âœ… Success!</div><pre>${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error: ${error.message}</div>`;
        }
      }

      async function quickPost() {
        const url = document.getElementById('api-url').value;
        const output = document.getElementById('api-output');

        try {
          output.innerHTML = '<div style="color: #f39c12;">Loading...</div>';
          const result = await haloTool.post(url, {
            message: 'Hello from haloTool!',
            timestamp: Date.now(),
          });
          output.innerHTML = `<div style="color: #27ae60;">âœ… POST Success!</div><pre>${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error: ${error.message}</div>`;
        }
      }

      async function quickGetWithState() {
        const url = document.getElementById('api-url').value;
        const output = document.getElementById('api-output');

        try {
          output.innerHTML = '<div style="color: #f39c12;">Loading...</div>';
          const result = await haloTool.get(url, 'apiData');
          output.innerHTML = `<div style="color: #27ae60;">âœ… Success! Data saved to state.apiData</div><pre>${JSON.stringify(result, null, 2)}</pre>`;
          updateStateDisplay();
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error: ${error.message}</div>`;
        }
      }

      async function createServerTool() {
        const output = document.getElementById('tool-output');

        try {
          output.innerHTML = '<div style="color: #f39c12;">Creating tool...</div>';

          const toolId = await haloTool.createServerTool({
            id: `demo_server_tool_${Date.now()}`,
            name: 'Demo Server Tool',
            description: 'A demonstration server tool',
            url: 'https://jsonplaceholder.typicode.com/posts/{{$.postId}}',
            method: 'GET',
            assignments: [
              {
                source: 'response',
                valuePath: '$.title',
                statePath: '$.postTitle',
              },
            ],
            cache: { ttlSec: 300, strategy: 'memory' },
          });

          output.innerHTML = `<div style="color: #27ae60;">âœ… Server tool created with ID: ${toolId}</div>`;
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error: ${error.message}</div>`;
        }
      }

      async function createSystemTool() {
        const output = document.getElementById('tool-output');

        try {
          output.innerHTML = '<div style="color: #f39c12;">Creating tool...</div>';

          const toolId = await haloTool.createSystemTool({
            id: `demo_system_tool_${Date.now()}`,
            name: 'Demo System Tool',
            description: 'A demonstration system tool',
            op: 'assign',
            path: '$.demo.systemValue',
            value: { message: 'Hello from system tool!', created: new Date().toISOString() },
          });

          output.innerHTML = `<div style="color: #27ae60;">âœ… System tool created with ID: ${toolId}</div>`;
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error: ${error.message}</div>`;
        }
      }

      async function executeCustomTool() {
        const output = document.getElementById('tool-output');
        const tools = haloTool.getAllTools();

        if (tools.length === 0) {
          output.innerHTML =
            '<div style="color: #f39c12;">âš ï¸ No tools available. Create a tool first!</div>';
          return;
        }

        try {
          const tool = tools[tools.length - 1]; // Get the last created tool
          output.innerHTML = `<div style="color: #f39c12;">Executing tool: ${tool.name}...</div>`;

          const context = {
            toolId: tool.id,
            instanceId: `exec_${Date.now()}`,
            startTime: Date.now(),
            triggeredBy: 'manual',
            state: haloTool.getState(),
          };

          const result = await haloTool.executeTool(tool.id, context);
          output.innerHTML = `<div style="color: #27ae60;">âœ… Tool executed successfully!</div><pre>${JSON.stringify(result, null, 2)}</pre>`;
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error: ${error.message}</div>`;
        }
      }

      function updateState() {
        const path = document.getElementById('state-path').value;
        const value = document.getElementById('state-value').value;

        try {
          // Try to parse as JSON, otherwise use as string
          let parsedValue;
          try {
            parsedValue = JSON.parse(value);
          } catch {
            parsedValue = value;
          }

          haloTool.updateState(path, parsedValue);
          updateStateDisplay();
        } catch (error) {
          alert(`Error updating state: ${error.message}`);
        }
      }

      function getState() {
        updateStateDisplay();
      }

      function clearState() {
        haloTool.setState({});
        updateStateDisplay();
      }

      function updateStateDisplay() {
        const display = document.getElementById('state-display');
        const state = haloTool.getState();
        console.log('State:', state);
        display.textContent = JSON.stringify(state, null, 2);
      }

      async function runWorkflow() {
        const output = document.getElementById('workflow-output');

        try {
          output.innerHTML = '<div style="color: #f39c12;">Running workflow...</div>';

          const results = await haloTool.workflow(['fetchData', 'processData', 'saveResults'], {
            workflowId: Date.now(),
          });

          output.innerHTML = `<div style="color: #27ae60;">âœ… Workflow completed!</div><pre>${JSON.stringify(results, null, 2)}</pre>`;
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Workflow failed: ${error.message}</div>`;
        }
      }

      async function runParallelWorkflow() {
        const output = document.getElementById('workflow-output');

        try {
          output.innerHTML = '<div style="color: #f39c12;">Running parallel workflow...</div>';

          const results = await Promise.all([
            haloTool.workflow(['task1', 'task2']),
            haloTool.workflow(['task3', 'task4']),
            haloTool.workflow(['task5', 'task6']),
          ]);

          output.innerHTML = `<div style="color: #27ae60;">âœ… Parallel workflows completed!</div><pre>${JSON.stringify(results, null, 2)}</pre>`;
        } catch (error) {
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Parallel workflow failed: ${error.message}</div>`;
        }
      }

      function showMetrics() {
        const output = document.getElementById('metrics-output');
        const metrics = haloTool.getMetrics();

        output.innerHTML = `<div style="color: #3498db;">ğŸ“Š Current Metrics:</div><pre>${JSON.stringify(metrics, null, 2)}</pre>`;
      }

      function showTools() {
        const output = document.getElementById('metrics-output');
        const tools = haloTool.getAllTools();

        output.innerHTML = `<div style="color: #3498db;">ğŸ”§ Registered Tools (${tools.length}):</div><pre>${JSON.stringify(
          tools.map(t => ({ id: t.id, name: t.name, type: t.type })),
          null,
          2
        )}</pre>`;
      }

      function simulateError() {
        const output = document.getElementById('metrics-output');

        try {
          throw new Error('This is a simulated error for testing');
        } catch (error) {
          const errorId = haloTool.captureError(error);
          output.innerHTML = `<div style="color: #e74c3c;">âŒ Error captured with ID: ${errorId}</div><div style="color: #95a5a6;">Error: ${error.message}</div>`;
        }
      }

      // Initialize state display
      setTimeout(() => {
        updateStateDisplay();
      }, 1500);
    </script>
  </body>
</html>
